
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: twistlock-view
rules:
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"] # Allow Defenders to list RBAC resources
  verbs: ["list"]
---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: twistlock-view-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: twistlock-view
subjects:
- apiGroup: 
  kind: ServiceAccount
  name: twistlock-service
  namespace: twistlock
---

apiVersion: v1
kind: SecurityContextConstraints
metadata:
  name: twistlock-scc
users:
- system:serviceaccount:twistlock:twistlock-service
allowHostDirVolumePlugin: true
allowHostIPC: false
allowHostNetwork: true
allowHostPID: true
allowHostPorts: true
allowPrivilegedContainer: false
allowedCapabilities:
- NET_ADMIN
- SYS_ADMIN
- SYS_PTRACE
- AUDIT_CONTROL
defaultAddCapabilities:
- NET_ADMIN
- SYS_ADMIN
- SYS_PTRACE
- AUDIT_CONTROL
fsGroup: # Volumes which support ownership management are modified to be owned and writable by the GID specified in fsGroup
  type: RunAsAny
priority: null
readOnlyRootFilesystem: true
requiredDropCapabilities: null
runAsUser:
  type: RunAsAny
seLinuxContext:
  type: RunAsAny
supplementalGroups: # Supplemental groups are regular Linux groups. When a process runs in Linux, it has a UID, a GID, and one or more supplemental groups.
  type: RunAsAny
volumes:
- '*' # Types of volumes the pod can mount. * is wildcard. https://docs.openshift.org/latest/architecture/additional_concepts/authorization.html#authorization-controlling-volumes
---
apiVersion: v1
kind: Secret
metadata:
  name: twistlock-secrets
  namespace: twistlock
type: Opaque
data:
  service-parameter: TWFCRjRqemZIaEhrV0JqOE0vYmYyeHRwU3pOdDloRENqUkNPMDdUWnBWdjNwMTg0ZFVCOEszYVc4c1ZEVVZxS3Z3cWVIZVJPNU14SUxBTFVHUFUvUnc9PQ==
  ca.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvVENDQWVXZ0F3SUJBZ0lRV1g1R1p6ZHF1ZVlmWUlQMzFFS0NCVEFOQmdrcWhraUc5dzBCQVFzRkFEQW8KTVJJd0VBWURWUVFLRXdsVWQybHpkR3h2WTJzeEVqQVFCZ05WQkFNVENWUjNhWE4wYkc5amF6QWVGdzB5TURBeApNekV4TURNME1EQmFGdzB5TXpBeE16QXhNRE0wTURCYU1DZ3hFakFRQmdOVkJBb1RDVlIzYVhOMGJHOWphekVTCk1CQUdBMVVFQXhNSlZIZHBjM1JzYjJOck1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0MKQVFFQXZvSkRPMERjSWZuUE1qMHhoM3BESmwvemhTVy9VNEpuaC9hcWYyb1FWQzZOVHJNcmVPY0VJbzhsVmhjRAovMFFtRHVoOENvYjN5eFZHWXlzTkNkcTJwMkd1MXZaVzZZZGRMWEU4TEJiZHpJdk5TK0FsNFdjWTBHS25sNUdwCldqMUlLZmNnN1R3cDZFaXVTdStpMHBuYWlhZFNnS0FyR0xZdEFuTnl5U0VhZ250ZEZGTFY0Z1h4R3l3SFVlMS8KN2hTVXJWQlBDLzdNdUoza1gzd2Rvb3RuOXVFRktJc2Y3eWUrTFhCZ0lNVjl3VHpXa2RtK2JidStVdnEzbk9xWQphc2tYbXFrdTR3dXp3YW9OWmg4Q1VmR1piWnNNS2Vzd1g0UWNHc09EdjJibVVka3VHcmpxakV5SjJTRDBDQ2hCCjIxVWF6UGhRbitmV0gwOFNRRUdjbXozQTBRSURBUUFCb3lNd0lUQU9CZ05WSFE4QkFmOEVCQU1DQXF3d0R3WUQKVlIwVEFRSC9CQVV3QXdFQi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFEbUluRU1Ed1ZNUVlVRVVqYzkwLwpBZlNxWkkrV2RDMGh4aWdXRjJodWRwakRGbkcwTDNzWVFwWEQxdG1sWnBNWGFkbDk2YTIyZDQxMVRFNGI4KzBPCjZHZ2tIQXpJdE1zU2hWQkkxUDFLZXdPTzhkdGkrSDhUN0kxOWV1TE42NkFLeFZkcGUvWXJtWkVhaU1mNGVMYnoKRXpwendUK3Vta1NsWHA2MXlrMlJXUS9hbG9rWHRJd2JsYy9RYys2ekdVb3NtUzdiZUZDNlFVenl0R0V2ZW1hUgpvV1ZtQUpHd3lvc3ZOdlo3ZEpEa0JSWGxjMWFYcThxUmVLcklUNDRVQzJENytrUlV2b2hDSmNIc2xKY0wwT0NpCmdVSm43UVJHRzY3U0o3dVVzZmZBcDh2U09aT2xiamlYck5PTEtaYVpLUFdRaTFhT0M4THIzemh5UHRLbEptbmgKc0E9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  client-cert.pem: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURHekNDQWdPZ0F3SUJBZ0lSQUpUbW16U25rR0N1TjRVNzZ6b01aOWN3RFFZSktvWklodmNOQVFFTEJRQXcKS0RFU01CQUdBMVVFQ2hNSlZIZHBjM1JzYjJOck1SSXdFQVlEVlFRREV3bFVkMmx6ZEd4dlkyc3dIaGNOTWpBdwpNakF6TURReE5EQXdXaGNOTWpNd01qQXlNRFF4TkRBd1dqQW9NUkl3RUFZRFZRUUtFd2xVZDJsemRHeHZZMnN4CkVqQVFCZ05WQkFNVENXeHZZMkZzYUc5emREQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0MKZ2dFQkFMODQ4RFI1QlozTmFyTVZlbXF1OXp1MytaZk5ReXVBZTZyUVVoL2RlVUp6Ym52LzAzdVIySDBaMUcxVgo2RUhWTmNJNk1VVXBSM3pKc3BkMU82ZmpxcGl5L0NscUdxWGdnVXlvZkJoRVB4WFZZZFUvZFVWci9rMlZQamVnCmV5MjhpbDdTNDNTYmE0dUxHS0VoSEJKVm1Zd3NRWTlOMUtuWnJ4WExLd3RjanhGMlEwd0plUEdKOFBwRDFublYKVG5CcHhwUTBwUE9pcDIvZDdaeWM3NWFBeVJ4Z2FBNEdoSDlwdjZBbXUrelZ1NGdYSWhzRFJzRmFId1FpTlVRNwp1V0h0c1B2WmRMaWZlQkFaeVlYOTVtK2M4YmN0OWIzeHg2aEJvVWhTNnlWVERBSUFpTlRGWVIvYU5nUkdQdFp2CjBvNmJzd3hmVi8zRWFBM1hMTkx6eXdPQk4zMENBd0VBQWFOQU1ENHdEZ1lEVlIwUEFRSC9CQVFEQWdlQU1CTUcKQTFVZEpRUU1NQW9HQ0NzR0FRVUZCd01DTUF3R0ExVWRFd0VCL3dRQ01BQXdDUVlGS2dRQkFnY0VBREFOQmdrcQpoa2lHOXcwQkFRc0ZBQU9DQVFFQVhROTRxRWhScEVZSjl4c0ZUeCtadTJIaDdPNS92Q3MvQXJndGpZakdIQ1RUClMwbmJiUEg0RzJEdnROTHFtQkd1L2U0TVRpMHUyN1ZNS2IxcVdjbTJEa2FneTJMWGt1TThsSzl6RzNDN3hxb1IKUHMzRVdLcWlHdVA0Tnk4eUJBWHp1cU4wTkRDTHQ2MG5PbG9ncXdERHFMaFhHLzBJbXZJZEp5WE43L3lEcjFvZQpYSm13NXNmY1pxZlNtT1ArSklGd0xjSEFSTVRodCtJckVweEJta2I0bUcxL0ZKL3dhTmZtTS9FM0VGcHBQR3hDCnAzSUpvZWVEcVRDTFVGMVFJaUpWU2pVb0lWaHg2WTArS29yUlQ5dlQwVUUwMmpVNEljVHV1WDFnK21sRTdrdnIKV0prQVhMblNUY09wZlNWQ0lMYy9zcm03MWJqODEwNmU2dWc3K0hNR29nPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  client-key.pem: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpQcm9jLVR5cGU6IDQsRU5DUllQVEVECkRFSy1JbmZvOiBBRVMtMjU2LUNCQyw3MmYwZTU0Zjg3MTVhNDUyOGQwZTc0NTY0ZDRjNjYzNgoKTU1xU1k2K3lmc0pIemZVckVIWkJFY2pmc2Q3SEg0MEwwUmlXS01mNW5HbmdoeUlFbXkvL24weXlUd1pMWjZ2eQo1bDF2YzNFclZ2bUNaWHZtb0piTUV4WGVvRitianMrRThIcFZIa3lKNW8wVlgvcDBLdENVeVY1QjNJUTRyRW1tCmw0VU45QkZJMXZIZU5uQXVTbmpsUW8yY2FiYjdTVFpDL2dBTnAvaFc0bERwRTV6SkM4K1UzWDAzRmRlTnVNYzkKQ2d2VzBtN3NDbFY1TzdYVzlzZHRmaHk5QmpES2J0OUhkL0VCOHVEZHdNZk5CdFFwcjVNOTh6WDF4Sm9zajZSSwpvMFA3WUFnRVJhWGFpNXhqMmpNY3FQYkhBM2RGZmd4WFY0eTRLK00zaUFPclpUTjd2aWxBSlE0Wm1MYi9sMTRmCnBuZXdhYXBGNEdod0ZaMmlYUDBzUGJFTW9KSzdDSVlrL0dmNmNralhtTmlacFhZckhScmNLSnpXOU1rUXJYSHEKZWVwSVIwT0dyNmhlZkpQZkt6TzlHM1VVS1cxbllJcFgvL1JzZkpjRllIMnd2Z0RjU3VraFUwSEFpd2NyZ2NLVQpmeFYxblU2OE5xR1M5OE1EaXV6S1BQRFEyd0xXNm5rVkZLTlRpSU9HRTJUYm05N25MOHFlZ2doNC8wY3phdTRPCkVrN0N6dEJxT2l5eEVDdmpFYm1EclVEbXgybVZKZTA0blJZWEhVN1R1YksySytySEpBSk51Z3ovTVIraHZvMTQKUzdlMmw1QUZYeTdEOHdQVjUzYXRCaC9qYU1iMXdEY3RBZXRNOGg3T0FZSnQ1TzVoTWlXY2Q3dUdLc3EzREUvMgpGeGk5M2MzRi91TWpBdnp1azhDRkk4bWprUzNha3VoSzcwTE8xVzBTYWplaWxZb3FJc2FHVnFjend6dndndEpoCk1IZHZwalNsSGRsU3NLOHA1RHo1QWQwTGlwSVdTRzVPRzNiSUZVTVlBVUw1SHpKMkpER2t1Vm9VR041NFkrTWYKdWpkazZienRMOE9UQnU0TlUzaFFOcFhod255STNOR05QNGtmem1XemZ6b3FxR0RGaklpZHlpM1RxOVhjZXBmdQppMXFaV0gyOUIzOUpZTVN1SkRPRFJJbUZyTEFCemNURStOVCttWlRyUHM3WlhoTzBZWWhOeUdYMGRjeDZab011CnFzandUWHVZRTczZWhOOU0wTUtlZ2xLcFd4eU9MZGlibmk3Y2ZTSzFPN1hrQmp5eEJWbENuZ3UvcHRZYXJQQTQKUGFxM0pCTDhNQTE3cmtnbFJzRlBCK3dwRlZnNDFPek9zL2tMRk5BejU2T3dwYmg0L0xQRFlhTEd4QlpsT0twZgpXMDQ0a3JVckl6OXc5Q2xDbnRvTDhEK2s3bW1OMnl0aXkrelRVNHQ3dnFqWW9yeUNuaXI3V3Bma3VHZldYaDl4CkF6emkvYmZqWW1VTitFM0JJMm1wRStaVXZLQzBTZVFMWWkvb1daRGhBU0w4T0k5eElnM3BQNW8rNGlsa0xWRlYKK0x3RkZzY0pzbWZaRWxIN0d6dHVjUVpZNFBoOTI4U28xaGpwcDV2U01NRVZvbXlDNm9FdmJURG41OWpIOHI1RApLUy96WEhGYzY1T2lldG5lOU9kajJDZThRa05QcjNCUnVkRWFFS1pVUUtxNnBGaGtEQzVFNThvcnFEclZ6cVUzCldEZEpEb0MrZVNwdGYvd05nUnVFUmhNV3ovYlhaMHdzWXJNOWlxQk9rMTU3cWg3NEFLcmx3b3RqUnhpN2t1YzgKSDE2ZklHWVlxbk1Na24yb3cwVzI3aUpSR3VGYWJ2VWRMeWdmd3IrOWtPV3hDUVNOOTg1MmJLaEJRd1VLQ3B4eAppb2szd0I2ZS92cDhHZUhhR1p4WTNPZDA0T2xWdXZDZ0crVGVvcGNDaTJVekxaRmYxLzltNFNOYjRkT0Fyc2RPCmIvdXRZVUNNQktGRkk4anQydVJIQVFLM2NON2RGQUpiK0pWd0RiOGorUkhjeGJDRkVPRUVaRGlVZnpxd2llMWUKc3BGSEZiUlhQU3FzTTJwekVobDhNSThrMm5HdWFhdDZPdytYRjlZa1pEeWpScDBsRGtEOE1SeXUrQmR0L3Z4aAotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=

---
apiVersion: v1
kind: ServiceAccount # Service Account is used for managing security context constraints policies in Openshift (SCC)
metadata:
  name: twistlock-service
  namespace: twistlock
secrets:
- name: twistlock-secrets
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: twistlock-defender-ds
  namespace: twistlock
spec:
  selector:
    matchLabels:
      app: twistlock-defender
  template:
    metadata:
      labels:
        app: twistlock-defender
    spec:
      serviceAccountName: twistlock-service
      restartPolicy: Always
      containers:
      - name: twistlock-defender
        image: registry-auth.twistlock.com/tw_9r3206kjz0gz12esgb8gwlpf5r0czvag/twistlock/defender:defender_19_11_512
        volumeMounts:
        - name: host-root
          mountPath: "/host"
        - name: data-folder
          mountPath: "/var/lib/twistlock"
        - name: certificates # Setting the certificates mount after data-folder since it is nested and was overridden in CRI based GKE cluster
          mountPath: "/var/lib/twistlock/certificates"
        - name: docker-sock-folder
          mountPath: "/var/run"
        - name: passwd
          mountPath: "/etc/passwd"
          readOnly: true
        - name: docker-netns
          mountPath: "/var/run/docker/netns"
          readOnly: true
        - name: syslog-socket
          mountPath: "/dev/log"
        - name: auditd-log
          mountPath: "/var/log/audit"
        - name: iptables-lock
          mountPath: "/run"
        env:
        - name: WS_ADDRESS
          value: wss://10.247.159.13:8084
        - name: DEFENDER_TYPE
          value: daemonset
        - name: DEFENDER_LISTENER_TYPE
          value: "none"
        - name: LOG_PROD
          value: "true"
        - name: SYSTEMD_ENABLED
          value: "false"
        - name: DOCKER_CLIENT_ADDRESS
          value: "/var/run/docker.sock"
        - name: DEFENDER_CLUSTER_ID
          value: "25eb7037-18eb-2079-fec2-cbbc9de92715"
        - name: MONITOR_SERVICE_ACCOUNTS
          value: "true"
        - name: MONITOR_ISTIO
          value: "false"
        - name: INSTALL_BUNDLE
          value: "eyJzZWNyZXRzIjp7fSwiZ2xvYmFsUHJveHlPcHQiOnsiaHR0cFByb3h5IjoiIiwibm9Qcm94eSI6IiIsImNhIjoiIiwidXNlciI6IiIsInBhc3N3b3JkIjp7ImVuY3J5cHRlZCI6IiJ9fX0="
        securityContext:
          readOnlyRootFilesystem: true
          privileged: false
          seLinuxOptions:
            type: docker_t
          capabilities:
            add:
            - NET_ADMIN  # NET_ADMIN - Required for process monitoring
            - SYS_ADMIN  # SYS_ADMIN - Required for filesystem monitoring
            - SYS_PTRACE # SYS_PTRACE - Required for local audit monitoring
            - AUDIT_CONTROL # AUDIT_CONTROL - required for system calls monitoring
        resources: # See: https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#how-pods-with-resource-requests-are-scheduled
          limits:
            memory: "512Mi"
            cpu: "900m"
          requests:
            cpu: "256m"
      volumes:
      - name: certificates
        secret:
          secretName: twistlock-secrets
          defaultMode: 256
      - name: syslog-socket
        hostPath:
          path: "/dev/log"
      - name: host-root
        hostPath:
          path: "/"
      - name: data-folder
        hostPath:
          path: "/var/lib/twistlock"
      - name: docker-netns
        hostPath:
          path: "/var/run/docker/netns"
      - name: passwd
        hostPath:
          path: "/etc/passwd"
      - name: docker-sock-folder
        hostPath:
          path: "/var/run"
      - name: auditd-log
        hostPath:
          path: "/var/log/audit"
      - name: iptables-lock
        hostPath:
          path: "/run"
      hostPID: true
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet